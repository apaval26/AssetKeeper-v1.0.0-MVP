{% extends 'main_admin.html' %}

{% block contentTitle %}
<title>Manage Bookings</title>
{% endblock contentTitle %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="/static/AppOneSDG/mystylesheetSDG.css">
<link rel="stylesheet" type="text/css" href="/static/AppOneSDG/contact-us.css">
<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
<style>
    #currentBooking, td, tr, th {
        border: 1px solid var(--table-border);
        color: var(--text-secondary);
    }
</style>
{% endblock extra_css %}



{% block contentBody %}

<div class = "wrapper">

    <div class = "overlay">
    
    <div class = "text">
    
    <h1 id = "intro" style = "color:white;">Manage Bookings </h1>
    
    </div>
    </div>
    </div>
    </div>
</div>

<br><br>
<h1 class="title" style="color: var(--text-primary);">Manage Bookings</h1>

<button id="exportBookingsBtn"
        class="bookingApprove"
        style="background:green;font-weight:bold; float:right;margin-right:40px;margin-bottom:50px;">
    Generate Report
</button>

<a href="{% url 'reservation_list_sorted' %}">
    <button class="bookingApprove" style="background:orange;font-weight:bold; float:right;margin-right:40px;margin-bottom:50px;">
        Sort From A to Z
    </button>
</a>

<a href="{% url 'reservation_list_sorted_desc' %}">
    <button class="bookingApprove" style="background:orange;font-weight:bold; float:right;margin-right:40px;margin-bottom:50px;">
        Sort From Z to A
    </button>
</a>

<br><br>

<input type="search"
       id="searchBar"
       placeholder="Search bookings"
       style="width:701px; font-size:18px; height:40px; margin-left:500px; color: var(--text-primary); background-color: var(--body-bg); border-bottom: 1px solid var(--table-border);">

<table style="width:100%" id="currentBooking">
    <tr>
        <th>User ID</th>
        <th>Reservation ID</th>
        <th>Status</th>
        <th>Quantity</th>
        <th>Equipment Borrowed</th>
        <th>Notes</th>
        <th>Return Date</th>
        <th>Actions</th>
    </tr>

    {% for reservation in reservationsToApprove %}
    <tr data-id="{{ reservation.reservationId }}">
        <td>{{ reservation.userId.username }}</td>
        <td>{{ reservation.reservationId }}</td>
        <td>{{ reservation.reservationStatus }}</td>
        <td>{{ reservation.quantityBorrowed }}</td>
        <td>[equipId: {{ reservation.equipId.equipId }} -- {{ reservation.equipId.equipName }}]</td>
        <td>{{ reservation.reservationNotes }}</td>
        <td>{{ reservation.returnDate }}</td>
        <td>
            <button class="bookingApprove" style="background:orange;font-weight:bold;">Approve</button>
            <br>
            <button id="bookingCancellation">Reject</button>
        </td>
    </tr>
    {% endfor %}
</table>

{% endblock contentBody %}

{% block extra_js %}
<script>
function fuzzyMatch(text, search) { if (!search) return true; if (text.includes(search)) return true; let i = 0; let j = 0; while (i < text.length && j < search.length) { if (text[i] === search[j]) { j++; } i++; } return (j / search.length) >= 0.6; }
document.addEventListener("DOMContentLoaded", function () {

    // LIVE SEARCH
    document.getElementById("searchBar").addEventListener("input", function () {
        const searchValue = this.value
            .toLowerCase()
            .replace(/\u00A0/g, " ")     // remove non-breaking spaces
            .replace(/\u200B/g, "")      // remove zero-width spaces
            .replace(/[^a-z0-9 ]/gi, "") // remove symbols
            .replace(/\s+/g, "")         // remove ALL spaces for matching
            .trim();
    
        const rows = document.querySelectorAll("#currentBooking tr");
    
        rows.forEach((row, index) => {
            if (index === 0) return;
    
            const cells = row.querySelectorAll("td");
            let match = false;
    
            cells.forEach(cell => {
                const text = cell.innerText
                    .toLowerCase()
                    .replace(/\u00A0/g, " ")
                    .replace(/\u200B/g, "")
                    .replace(/[^a-z0-9 ]/gi, "")
                    .replace(/\s+/g, "")  // remove ALL spaces
                    .trim();
    

            if (fuzzyMatch(text, searchValue)) { match = true; }
            });
    
            row.style.display = match ? "" : "none";
        });
    });

    // EXPORT ONLY VISIBLE ROWS
    document.getElementById("exportBookingsBtn").addEventListener("click", function () {
        const visibleIds = [];
        const dataRows = document.querySelectorAll("#currentBooking tr[data-id]");
    
        dataRows.forEach(row => {
            if (row.style.display !== "none") {
                visibleIds.push(row.getAttribute("data-id"));
            }
        });
    
        if (visibleIds.length === 0) {
            alert("No results to export.");
            return; // stop here
        }
    
        const params = new URLSearchParams();
        params.append("ids", visibleIds.join(","));
    
        window.location.href = `/export_bookings_csv/?${params.toString()}`;
    });

});
</script>
{% endblock extra_js %}
